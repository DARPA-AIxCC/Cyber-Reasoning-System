# LibAFL-KCOV Kernel Fuzzer

## Prep

### Kernel Patches

Before using, you'll need to apply all of the patches in the `kernel-patches` dir to the kernel source.
You can do this with the `apply.sh` script, executed from the root source directory of the kernel.
You'll need to set the `$PATCHES_DIR` environment variable to be the path to the `kernel-patches` directory before executing.
An example of this is in the `crs_entrypoint.py` script.

### Disk Image

The current config will build a disk image automatically on-the-fly.

This can be slow, so for local testing you can use the prebaked image by setting `create_new_disk_image = False` in the `crs_entrypoint.py` script or by directly creating your own command JSON pointing to a prebaked image.
A pre-baked `.qcow2` disk image has been included in `challenge-001-cp-files/root.qcow2.zst` via LFS.
Decompress it with `zstd` to use.

### Configuration

The fuzzer reads in a `.json` file containing a Qemu command generated by `virtme-ng --show-command`.
To make things work on your machine, you need to change the `-kernel` option to point to the compiled (*patched*) kernel on your system.
Additionally, you need to change the `-drive` file to point to the `.qcow2` disk image.
These are hardcoded for Dylan's local machine in the `challenge-001-cp-files/run.json` and replaced with `{}` in `challenge-001-cp-files/template.json`.
See `crs_entrypoint.py` for examples on how to fill in these values dynamically.


## Usage

`cargo run -- -q <path to json>`

Note that it takes a minute or two for the VM to start up on slower systems.

See `cargo run -- -h` for the full CLI options.

To run with your own custom kernel, you need to aplp

## CRS Integration And Local Testing

To run in the CRS, just pass a `meta-data.json` config file to `crs-entrypoint.py`.
For local testing, you can clone the linux kernel CP into this directory, and use the pre-generated `challenge-001-cp-files/meta-data.json` to run the fuzzer.
When running outside of the DARPA environment, you'll need to uncomment the `make` commands at the top of the python script to prepare the kernel source.

### CRS Hacks to fix

- [ ] why do we need sudo?
